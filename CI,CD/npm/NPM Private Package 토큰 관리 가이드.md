# NPM Private Package ν† ν° κ΄€λ¦¬ κ°€μ΄λ“

## κ°μ”

μ΄ λ¬Έμ„λ” `@private-package` μ¤μ½”ν”„μ ν”„λΌμ΄λΉ— NPM ν¨ν‚¤μ§€λ¥Ό μ‚¬μ©ν•κΈ° μ„ν• ν† ν° κ΄€λ¦¬ λ°©λ²•μ„ μ„¤λ…ν•©λ‹λ‹¤.

## λ©μ°¨

1. [ν”„λΌμ΄λΉ— ν¨ν‚¤μ§€λ€?](#ν”„λΌμ΄λΉ—-ν¨ν‚¤μ§€λ€)
2. [ν† ν°μ μΆ…λ¥μ™€ μ—­ν• ](#ν† ν°μ-μΆ…λ¥μ™€-μ—­ν• )
3. [μ „μ²΄ μΈμ¦ μ‚¬μ΄ν΄](#μ „μ²΄-μΈμ¦-μ‚¬μ΄ν΄)
4. [λ΅μ»¬ κ°λ° ν™κ²½ μ„¤μ •](#λ΅μ»¬-κ°λ°-ν™κ²½-μ„¤μ •)
5. [GCP Cloud Build ν™κ²½](#gcp-cloud-build-ν™κ²½)
6. [ν† ν° κµμ²΄ μ μ°¨](#ν† ν°-κµμ²΄-μ μ°¨)
7. [λ³΄μ• κ³ λ ¤μ‚¬ν•­](#λ³΄μ•-κ³ λ ¤μ‚¬ν•­)

---

## ν”„λΌμ΄λΉ— ν¨ν‚¤μ§€λ€?

### Public vs Private ν¨ν‚¤μ§€

```bash
# Public ν¨ν‚¤μ§€ (ν† ν° λ¶ν•„μ”)
npm install react
npm install lodash

# Private ν¨ν‚¤μ§€ (ν† ν° ν•„μ π”)
npm install @private-package/piip-ui-components
npm install @private-package/piip-utils
```

### ν”„λ΅μ νΈμ—μ„ μ‚¬μ© μ¤‘μΈ @private-package ν¨ν‚¤μ§€

```json
{
  "dependencies": {
    "@private-package/piip-admin-modules": "^1.0.9",
    "@private-package/piip-auth-modules": "^1.0.67",
    "@private-package/piip-automation-modules": "^1.0.81",
    "@private-package/piip-cases-modules": "^1.0.321",
    "@private-package/piip-customers-modules": "^1.0.169",
    "@private-package/piip-finance-modules": "^1.0.133",
    "@private-package/piip-monitoring-modules": "^1.0.34",
    "@private-package/piip-site-modules": "^1.0.233",
    "@private-package/piip-ui-components": "^1.0.109",
    "@private-package/piip-utils": "^1.0.56",
    "@private-package/piip-webapp-modules": "^1.0.147"
  }
}
```

**μ΄ λ¨λ“  ν¨ν‚¤μ§€λ” NPM μΈμ¦ ν† ν° μ—†μ΄λ” μ„¤μΉν•  μ μ—†μµλ‹λ‹¤.**

---

## ν† ν°μ μΆ…λ¥μ™€ μ—­ν• 

### 1. λ΅μ»¬ κ°λ°μ© ν† ν°

- **μ„μΉ**: `~/.npmrc` (κ°λ°μμ μ»΄ν“¨ν„°)
- **μ©λ„**: λ΅μ»¬μ—μ„ `yarn install` μ‹¤ν–‰ μ‹ μ‚¬μ©
- **ν•μ‹**:
  ```
  //registry.npmjs.org/:_authToken=npm_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  ```
- **λ§λ£**: μ¥κΈ° (μ: 2999λ…„)
- **κ¶ν•**: Read-only

### 2. GCP Cloud Buildμ© ν† ν°

- **μ„μΉ**: `staging-npm.enc`, `npm.enc` (KMSλ΅ μ•”νΈν™”λ νμΌ)
- **μ©λ„**: CI/CD λΉλ“ μ‹ μ‚¬μ©
- **ν•μ‹**: μ•”νΈν™”λ λ°”μ΄λ„λ¦¬ λ°μ΄ν„°
- **λ§λ£**: μ¥κΈ°λ΅ μ„¤μ • κ¶μ¥
- **κ¶ν•**: Read-only

---

## μ „μ²΄ μΈμ¦ μ‚¬μ΄ν΄

### λ΅μ»¬ κ°λ° ν™κ²½

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 1. κ°λ°μκ°€ yarn install μ‹¤ν–‰                           β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 2. NPMμ΄ ~/.npmrc νμΌ μ½κΈ°                             β”‚
β”‚    //registry.npmjs.org/:_authToken=npm_xxxxx           β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 3. NPM Registryμ— ν† ν°κ³Ό ν•¨κ» μ”μ²­                      β”‚
β”‚    GET @private-package/piip-ui-components                    β”‚
β”‚    Authorization: Bearer npm_xxxxx                      β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 4. NPM Registryκ°€ ν† ν° κ²€μ¦                             β”‚
β”‚    β… μ ν¨ν• ν† ν° β†’ ν¨ν‚¤μ§€ λ‹¤μ΄λ΅λ“ ν—μ©                β”‚
β”‚    β λ¬΄ν¨ν• ν† ν° β†’ 401 Unauthorized μ—λ¬               β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 5. ν¨ν‚¤μ§€ μ„¤μΉ μ™„λ£                                     β”‚
β”‚    node_modules/@private-package/piip-ui-components/          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### GCP Cloud Build ν™κ²½

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 1. Cloud Build νΈλ¦¬κ±° μ‹¤ν–‰                              β”‚
β”‚    (git push, manual trigger λ“±)                        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 2. KMSλ΅ μ•”νΈν™”λ ν† ν° νμΌ λ³µνΈν™”                      β”‚
β”‚    gcloud kms decrypt                                   β”‚
β”‚      --ciphertext-file=staging-npm.enc  (μ•”νΈλ¬Έ)        β”‚
β”‚      --plaintext-file=.npmrc            (ν‰λ¬Έ)          β”‚
β”‚      --keyring=piip-intra-staging-keyring               β”‚
β”‚      --key=api-config-key                               β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 3. λ³µνΈν™”λ .npmrc νμΌ μƒμ„±                            β”‚
β”‚    //registry.npmjs.org/:_authToken=npm_xxxxx           β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 4. .npmrcλ¥Ό ν¨ν‚¤μ§€ λ””λ ‰ν† λ¦¬λ΅ λ³µμ‚¬                      β”‚
β”‚    cp .npmrc ./packages/piip-webapp-intranet/.npmrc     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 5. yarn install μ‹¤ν–‰                                    β”‚
β”‚    (μ΄μ  ν† ν°μ΄ μμΌλ―€λ΅ ν”„λΌμ΄λΉ— ν¨ν‚¤μ§€ μ„¤μΉ κ°€λ¥)     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 6. NPM Registryμ—μ„ @private-package ν¨ν‚¤μ§€ λ‹¤μ΄λ΅λ“          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 7. yarn bootstrap (Lerna monorepo μ„¤μ •)                β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 8. Docker μ΄λ―Έμ§€ λΉλ“                                   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                  β”‚
                  β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 9. GCP App Engineμ— λ°°ν¬                                β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## λ΅μ»¬ κ°λ° ν™κ²½ μ„¤μ •

### 1. NPM ν† ν° μƒμ„±

NPM μ›Ήμ‚¬μ΄νΈμ—μ„ ν† ν° μƒμ„±:

- https://www.npmjs.com/settings/marknavi/tokens
- νƒ€μ…: **Automation** (λλ” Legacy)
- κ¶ν•: **Read-only**
- λ§λ£: μµλ€ν• κΈΈκ² μ„¤μ •

### 2. λ΅μ»¬ .npmrc μ„¤μ •

```bash
# ~/.npmrc νμΌμ— ν† ν° μ¶”κ°€
echo "//registry.npmjs.org/:_authToken=npm_YOUR_TOKEN_HERE" > ~/.npmrc
```

### 3. ν† ν° κ²€μ¦

```bash
# ν† ν°μ΄ μ ν¨ν•μ§€ ν™•μΈ
npm whoami
# μ¶λ ¥: marknavi (κ³„μ • μ΄λ¦„μ΄ λ‚μ¤λ©΄ μ„±κ³µ)

# 401 Unauthorized μ—λ¬ λ°μƒ μ‹ ν† ν° λ¬Έμ 
```

### 4. ν¨ν‚¤μ§€ μ„¤μΉ ν…μ¤νΈ

```bash
# ν”„λ΅μ νΈ λ£¨νΈμ—μ„
yarn install
yarn bootstrap
```

---

## GCP Cloud Build ν™κ²½

### νμΌ κµ¬μ΅°

```
piip-webapp-monorepo/
β”β”€β”€ staging-npm.enc          # Staging ν™κ²½μ© μ•”νΈν™”λ ν† ν°
β”β”€β”€ npm.enc                  # Production ν™κ²½μ© μ•”νΈν™”λ ν† ν°
β””β”€β”€ packages/
    β””β”€β”€ piip-webapp-intranet/
        β””β”€β”€ piip-intranet-staging-build.yaml  # Cloud Build μ„¤μ •
```

### Cloud Build μ„¤μ • (piip-intranet-staging-build.yaml)

```yaml
steps:
  # Step 1: KMSλ΅ μ•”νΈν™”λ NPM ν† ν° λ³µνΈν™”
  - name: "gcr.io/cloud-builders/gcloud"
    args:
      - kms
      - decrypt
      - --ciphertext-file=staging-npm.enc # μ•”νΈν™”λ νμΌ
      - --plaintext-file=.npmrc # λ³µνΈν™”λ  νμΌ
      - --location=global
      - --keyring=${_KEYRING} # piip-intra-staging-keyring
      - --key=${_NPM_KEY} # api-config-key
    id: "Decrypt npm key"

  # Step 2: λ³µνΈν™”λ .npmrcλ¥Ό ν¨ν‚¤μ§€ λ””λ ‰ν† λ¦¬λ΅ λ³µμ‚¬
  - name: "ubuntu"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        cp .npmrc ./packages/${_SERVICE_NAME}/.npmrc
    id: "Copy npm key"

  # Step 3: Yarn λ΅κ·Έμ•„μ›ƒ (κΈ°μ΅΄ μΈμ¦ μ κ±°)
  - name: node:${_NODE_VERSION}
    entrypoint: yarn
    args: ["logout"]
    id: "Logout yarn"

  # Step 4: ν„μ¬ NPM μ‚¬μ©μ ν™•μΈ
  - name: node:${_NODE_VERSION}
    entrypoint: npm
    args: ["whoami"]
    id: "Check current logged npm user"

  # Step 5: ν¨ν‚¤μ§€ μ„¤μΉ (μ΄μ  .npmrcμ— ν† ν°μ΄ μμ)
  - name: node:${_NODE_VERSION}
    entrypoint: yarn
    args: ["install"]
    id: "Yarn install"

  # Step 6: Lerna bootstrap
  - name: node:${_NODE_VERSION}
    entrypoint: yarn
    args: ["bootstrap"]
    id: "Yarn Lerna bootstrap"
```

### GCP ν™κ²½λ³„ KMS μ„¤μ •

#### Staging ν™κ²½

```bash
Project: piip-intra-staging
Keyring: piip-intra-staging-keyring
Key: api-config-key
Encrypted file: staging-npm.enc
```

#### Production ν™κ²½

```bash
Project: piip-intra
Keyring: piip-intra-keyring
Key: api-config-key
Encrypted file: npm.enc
```

---

## ν† ν° κµμ²΄ μ μ°¨

### μ™ ν† ν°μ„ κµμ²΄ν•΄μ•Ό ν•λ‚?

- κΈ°μ΅΄ ν† ν° λ§λ£ (μ: 90μΌ λ‹¨κΈ° ν† ν°)
- λ³΄μ• μ •μ±… λ³€κ²½
- ν† ν° μ μ¶ μμ‹¬

### 1. μƒ NPM ν† ν° μƒμ„±

```bash
# NPM CLIλ΅ μƒμ„±
npm token create --read-only --cidr=0.0.0.0/0

# λλ” NPM μ›Ήμ‚¬μ΄νΈμ—μ„ μƒμ„±
# https://www.npmjs.com/settings/marknavi/tokens
```

**2κ° μƒμ„±:**

- λ΅μ»¬ κ°λ°μ© ν† ν°
- GCP Cloud Buildμ© ν† ν°

### 2. λ΅μ»¬ ν† ν° κµμ²΄

```bash
# κΈ°μ΅΄ .npmrc λ°±μ—…
cp ~/.npmrc ~/.npmrc.backup.$(date +%Y%m%d)

# μƒ ν† ν°μΌλ΅ κµμ²΄
cat > ~/.npmrc << 'EOF'
//registry.npmjs.org/:_authToken=npm_NEW_TOKEN_HERE
EOF

# κ²€μ¦
npm whoami
```

### 3. GCPμ© .npmrc νμΌ μ¤€λΉ„

```bash
# ν”„λ΅μ νΈ λ£¨νΈμ—μ„ (μ£Όμ: μ΄ νμΌμ€ μ»¤λ°‹ν•μ§€ μ•μ!)
cat > .npmrc << 'EOF'
//registry.npmjs.org/:_authToken=npm_GCP_TOKEN_HERE
EOF
```

### 4. KMSλ΅ μ•”νΈν™”

#### Staging ν™κ²½

```bash
gcloud kms encrypt \
  --plaintext-file=.npmrc \
  --ciphertext-file=staging-npm.enc \
  --location=global \
  --keyring=piip-intra-staging-keyring \
  --key=api-config-key \
  --project=piip-intra-staging
```

#### Production ν™κ²½

```bash
gcloud kms encrypt \
  --plaintext-file=.npmrc \
  --ciphertext-file=npm.enc \
  --location=global \
  --keyring=piip-intra-keyring \
  --key=api-config-key \
  --project=piip-intra
```

### 5. μ•”νΈν™” κ²€μ¦

```bash
# Staging ν† ν° λ³µνΈν™” ν…μ¤νΈ
gcloud kms decrypt \
  --ciphertext-file=staging-npm.enc \
  --plaintext-file=/dev/stdout \
  --location=global \
  --keyring=piip-intra-staging-keyring \
  --key=api-config-key \
  --project=piip-intra-staging

# μ¶λ ¥: //registry.npmjs.org/:_authToken=npm_xxxxx
```

### 6. ν‰λ¬Έ .npmrc μ‚­μ  (μ¤‘μ”!)

```bash
# ν”„λ΅μ νΈ λ£¨νΈμ .npmrc μ‚­μ  (ν† ν° λ…Έμ¶ λ°©μ§€)
rm .npmrc
```

### 7. Git μ»¤λ°‹ λ° λ°°ν¬

```bash
# μ•”νΈν™”λ νμΌλ§ μ»¤λ°‹
git add staging-npm.enc npm.enc
git commit -m "chore: update NPM tokens for long-term validity"
git push
```

### 8. κΈ°μ΅΄ ν† ν° μ‚­μ  (μ„ νƒμ‚¬ν•­)

```bash
# λ³΄μ•μ„ μ„ν•΄ κΈ°μ΅΄ ν† ν° μ‚­μ 
npm token revoke OLD_TOKEN_HERE

# λλ” NPM μ›Ήμ‚¬μ΄νΈμ—μ„ μ‚­μ 
# https://www.npmjs.com/settings/marknavi/tokens
```

---

## λ³΄μ• κ³ λ ¤μ‚¬ν•­

### β… μ•μ „ν• λ°©λ²•

1. **μ•”νΈν™”λ νμΌλ§ Gitμ— μ»¤λ°‹**

   - `staging-npm.enc` β…
   - `npm.enc` β…

2. **ν‰λ¬Έ .npmrcλ” μ λ€ μ»¤λ°‹ν•μ§€ μ•μ**

   - `.gitignore`μ— `.npmrc` μ¶”κ°€

   ```gitignore
   # NPM
   .npmrc
   ```

3. **λ΅μ»¬ .npmrcλ” ν™ λ””λ ‰ν† λ¦¬μ—λ§**

   - `~/.npmrc` (μ „μ—­ μ„¤μ •)
   - ν”„λ΅μ νΈ λ£¨νΈμ `.npmrc`λ” μ•”νΈν™”μ©μΌλ΅λ§ μ‚¬μ© ν›„ μ‚­μ 

4. **Read-only ν† ν° μ‚¬μ©**

   - ν¨ν‚¤μ§€ λ‹¤μ΄λ΅λ“λ§ κ°€λ¥
   - ν¨ν‚¤μ§€ λ°°ν¬ κ¶ν• μ—†μ

5. **μ¥κΈ° ν† ν° μ‚¬μ©**
   - λ§λ£μΌμ„ μµλ€ν• κΈΈκ² μ„¤μ • (μ: 2999λ…„)
   - 90μΌλ§λ‹¤ κµμ²΄ν•λ” μκ³  λ°©μ§€

### β μ„ν—ν• λ°©λ²•

1. **ν‰λ¬Έ ν† ν°μ„ Gitμ— μ»¤λ°‹**

   ```bash
   # μ λ€ ν•μ§€ λ§ κ²ƒ!
   git add .npmrc
   ```

2. **ν† ν°μ„ μ½”λ“μ— ν•λ“μ½”λ”©**

   ```javascript
   // μ λ€ ν•μ§€ λ§ κ²ƒ!
   const NPM_TOKEN = "npm_xxxxx";
   ```

3. **ν† ν°μ„ Slack, μ΄λ©”μΌλ΅ μ „μ†΅**

   - ν† ν° μ μ¶ μ„ν—

4. **Read-write ν† ν° μ‚¬μ©**
   - μµμ† κ¶ν• μ›μΉ™ μ„λ°

### μ•”νΈν™”/λ³µνΈν™” μ›λ¦¬

#### μ•”νΈν™” (Encrypt)

```
ν‰λ¬Έ .npmrc                    μ•”νΈλ¬Έ staging-npm.enc
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”          β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ //registry...    β”‚          β”‚ 0a24 00bc 42e4   β”‚
β”‚ :_authToken=     β”‚  β”€β”€KMSβ”€β”€>β”‚ 447d 98dd 901f   β”‚
β”‚ npm_xxxxx        β”‚          β”‚ fa27 1735 624a   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”          β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   (μ½μ„ μ μμ)                 (μ½μ„ μ μ—†μ)
```

#### λ³µνΈν™” (Decrypt)

```
μ•”νΈλ¬Έ staging-npm.enc         ν‰λ¬Έ .npmrc
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”          β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 0a24 00bc 42e4   β”‚          β”‚ //registry...    β”‚
β”‚ 447d 98dd 901f   β”‚  β”€β”€KMSβ”€β”€>β”‚ :_authToken=     β”‚
β”‚ fa27 1735 624a   β”‚          β”‚ npm_xxxxx        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”          β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   (μ½μ„ μ μ—†μ)                 (μ½μ„ μ μμ)
```

#### μ¤‘μ”ν• νΉμ§•

- **κ°™μ€ ν‰λ¬Έ β†’ λ‹¤λ¥Έ μ•”νΈλ¬Έ**: λ§¤λ² μ•”νΈν™”ν•  λ•λ§λ‹¤ λ‹¤λ¥Έ μ•”νΈλ¬Έ μƒμ„± (λ³΄μ• κ°•ν™”)
- **λ‹¤λ¥Έ KMS ν‚¤ β†’ λ‹¤λ¥Έ μ•”νΈλ¬Έ**: stagingκ³Ό productionμ€ λ‹¤λ¥Έ ν‚¤λ΅ μ•”νΈν™”
- **λ³µνΈν™” κ²°κ³Όλ” λ™μΌ**: μ–΄λ–¤ ν™κ²½μ—μ„λ“  κ°™μ€ ν‰λ¬ΈμΌλ΅ λ³µνΈν™”λ¨

---

## νΈλ¬λΈ”μν…

### λ¬Έμ : 401 Unauthorized μ—λ¬

```bash
npm ERR! code E401
npm ERR! 401 Unauthorized - GET https://registry.npmjs.org/@private-package/piip-ui-components
```

**μ›μΈ:**

- NPM ν† ν°μ΄ μ—†κ±°λ‚ μλ»λ¨
- ν† ν°μ΄ λ§λ£λ¨

**ν•΄κ²°:**

```bash
# 1. ν† ν° ν™•μΈ
npm whoami

# 2. ν† ν°μ΄ μ ν¨ν•μ§€ μ•μΌλ©΄ μƒλ΅ μƒμ„±
npm token create --read-only

# 3. ~/.npmrc μ—…λ°μ΄νΈ
echo "//registry.npmjs.org/:_authToken=npm_NEW_TOKEN" > ~/.npmrc
```

### λ¬Έμ : Cloud Buildμ—μ„ ν¨ν‚¤μ§€ μ„¤μΉ μ‹¤ν¨

**μ›μΈ:**

- KMS λ³µνΈν™” μ‹¤ν¨
- μ•”νΈν™”λ ν† ν°μ΄ μ¤λλμ–΄ λ§λ£λ¨

**ν•΄κ²°:**

```bash
# 1. λ΅μ»¬μ—μ„ λ³µνΈν™” ν…μ¤νΈ
gcloud kms decrypt \
  --ciphertext-file=staging-npm.enc \
  --plaintext-file=/dev/stdout \
  --location=global \
  --keyring=piip-intra-staging-keyring \
  --key=api-config-key \
  --project=piip-intra-staging

# 2. λ³µνΈν™”λ ν† ν°μΌλ΅ ν…μ¤νΈ
echo "λ³µνΈν™”λ_λ‚΄μ©" | npm whoami --userconfig=/dev/stdin

# 3. ν† ν°μ΄ λ§λ£λμ—μΌλ©΄ μƒλ΅ μ•”νΈν™”
```

### λ¬Έμ : staging-npm.encμ™€ npm.encκ°€ μ™ λ‹¤λ¥Έκ°€?

**μ΄μ :**

1. λ‹¤λ¥Έ GCP ν”„λ΅μ νΈμ λ‹¤λ¥Έ KMS ν‚¤λ΅ μ•”νΈν™”
2. KMSλ” λ§¤λ² μ•”νΈν™”ν•  λ•λ§λ‹¤ λ‹¤λ¥Έ μ•”νΈλ¬Έ μƒμ„± (λ³΄μ• κ°•ν™”)

**ν™•μΈ:**

```bash
# λ‘ νμΌμ΄ λ‹¤λ¥Έ λ°”μ΄λ„λ¦¬μ„μ„ ν™•μΈ
diff staging-npm.enc npm.enc
# Binary files staging-npm.enc and npm.enc differ

# ν•μ§€λ§ λ³µνΈν™”ν•λ©΄ κ°™μ€ λ‚΄μ©
gcloud kms decrypt ... --ciphertext-file=staging-npm.enc
gcloud kms decrypt ... --ciphertext-file=npm.enc
# λ‘ μ¶λ ¥ κ²°κ³Όλ” λ™μΌ
```

---

## μ°Έκ³  μλ£

### NPM ν† ν° κ΄€λ¦¬

- [NPM Token Documentation](https://docs.npmjs.com/about-access-tokens)
- [Creating and Viewing Access Tokens](https://docs.npmjs.com/creating-and-viewing-access-tokens)

### GCP KMS

- [Cloud KMS Documentation](https://cloud.google.com/kms/docs)
- [Encrypt and Decrypt Data](https://cloud.google.com/kms/docs/encrypt-decrypt)

---

## μ”μ•½

1. **ν”„λΌμ΄λΉ— ν¨ν‚¤μ§€**λ” NPM ν† ν° μ—†μ΄ μ„¤μΉ λ¶κ°€λ¥
2. **λ΅μ»¬ κ°λ°**: `~/.npmrc`μ— ν† ν° μ €μ¥
3. **Cloud Build**: KMSλ΅ μ•”νΈν™”λ ν† ν° μ‚¬μ©
4. **μ•”νΈν™” κ³Όμ •**: ν‰λ¬Έ `.npmrc` β†’ KMS μ•”νΈν™” β†’ `staging-npm.enc` / `npm.enc`
5. **λ³µνΈν™” κ³Όμ •**: `staging-npm.enc` β†’ KMS λ³µνΈν™” β†’ ν‰λ¬Έ `.npmrc` β†’ `yarn install`
6. **λ³΄μ•**: ν‰λ¬Έ ν† ν°μ€ μ λ€ Gitμ— μ»¤λ°‹ν•μ§€ μ•μ
7. **ν† ν° κµμ²΄**: μƒ ν† ν° μƒμ„± β†’ μ•”νΈν™” β†’ μ»¤λ°‹ β†’ λ°°ν¬
